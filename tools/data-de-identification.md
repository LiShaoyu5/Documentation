# 配置和执行数据脱敏

**重要** 本文中含有需要您注意的重要提示信息，忽略该信息可能对您的业务造成影响，请务必仔细阅读。

数据安全中心 DSC（Data Security Center）支持静态脱敏和动态脱敏。静态脱敏通过创建脱敏任务，指定目标数据资产，并依据脱敏规则匹配目标敏感字段，采用脱敏算法（如遮盖、加密或替换等）对指定字段进行处理，最终将脱敏后的数据保存至用户选择的目标位置。而动态脱敏则是通过调用 `ExecDatamask` 接口，依照脱敏规则对 JSON 格式数据中指定字段进行数据脱敏处理。

## 选择脱敏方式

| 脱敏方式 | 支持脱敏的数据源 | 应用场景 | 操作方式 |
| :--- | :--- | :--- | :--- |
| **静态脱敏** | <ul><li>RDS表、PolarDB-X表、MaxCompute表、PolarDB表、OceanBase表、AnalyticDB-MySQL表、ECS自建数据库表。</li><li>OSS Bucket中结构化TXT、CSV、XLSX和XLS格式文件。</li><li>本地计算机保存的结构化TXT、CSV、XLSX和XLS格式文件。</li></ul> | 需要将目标数据源与其他用户共享，但不能泄露某些敏感字段数据的业务场景。使用静态脱敏方式，脱敏指定数据表或文件后，可将脱敏后数据另存到其他数据表或文件中，实现数据共享，且不会影响原始的数据。 | 在DSC控制台，通过新增脱敏任务，设置脱敏数据、脱敏规则、脱敏后数据保存的目的地、执行任务周期等。 |
| **动态脱敏** | 自行构造符合以下JSON格式的数据，其中`dataHeaderList`定义数据的列名，`dataList`定义脱敏的数据，`dataHeaderList`中列名顺序和`dataList`中数据顺序必须一一对应。`ruleList`用于匹配脱敏规则。<br> <pre><code>{ <br>  "dataHeaderList": ["name", "age"], <br>  "dataList": [ ["lily", 18], ["lucy", 17] ], <br>  "ruleList": [1002, null] <br>}</code></pre> | 脱敏方式更加灵活，可由您自行构造待脱敏的数据源。 | 通过OpenAPI在线调试、SDK或自定义封装API的调用方式，调用接口 `ExecDatamask` - 对数据进行动态脱蒙进行开发与部署。具体内容，请参见集成概览。 |

## 脱敏结果示例

DSC 提供的脱敏算法包含：
* 哈希脱敏
* 遮盖脱敏
* 替换脱敏
* 变换脱敏
* 加密脱敏
* 洗牌脱敏

不同脱敏算法脱敏后示例如下。

### 哈希脱敏

<table>
  <thead>
    <tr>
      <th>适用类型和典型场景</th>
      <th>算法描述</th>
      <th>算法配置示例</th>
      <th>脱敏前数据示例</th>
      <th>脱敏结果示例</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="4">不可逆算法。支持常见的哈希算法，并支持偏移量（加盐值）配置。<br>适用于密码或需要通过对比进行敏感数据确认的场景。<br><ul><li><strong>敏感类型</strong>：密钥类。</li><li><strong>适用场景</strong>：数据存储。</li></ul></td>
      <td>MD5</td>
      <td>加盐值为`测试`</td>
      <td rowspan="4">`123456`</td>
      <td>`d6f82c64df3dc34921d79e5f22e5d43a`</td>
    </tr>
    <tr>
      <td>SHA-1</td>
      <td></td>
      <td>`59056c7c7faa5eeb7151d30a01c17b25f35b021c`</td>
    </tr>
    <tr>
      <td>SHA-256</td>
      <td></td>
      <td>`84ca63076a5966e9b726490c8b6a5c9c6d6bdc018bb0a05df754c0c2770aca72`</td>
    </tr>
    <tr>
      <td>HMAC</td>
      <td></td>
      <td>`ed029027322fedb0ac40b7759ac1521f0121cb018cf0f6f078e61764d810e00f`</td>
    </tr>
  </tbody>
</table>

### 遮盖脱敏

<table>
  <thead>
    <tr>
      <th>适用类型和典型场景</th>
      <th>算法描述</th>
      <th>算法配置示例</th>
      <th>脱敏前数据示例</th>
      <th>脱敏结果示例</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="6">不可逆算法。通过使用特殊字符星号（*）或者井号（#），对部分文字进行遮盖实现敏感数据的脱敏。<br>适用于前端展示或敏感数据分享的场景。<br><ul><li><strong>敏感类型</strong>：个人敏感。</li><li><strong>适用场景</strong>：<ul><li>数据使用。</li><li>数据分享。</li></ul></li></ul></td>
      <td>保留前n后m</td>
      <td>遮盖字符为`*`，n=1、m=1</td>
      <td rowspan="4">`123456`</td>
      <td>`1****6`</td>
    </tr>
    <tr>
      <td>保留自x至y</td>
      <td>遮盖字符为`*`，x=3、y=4</td>
      <td>`**34**`</td>
    </tr>
    <tr>
      <td>遮盖前n后m</td>
      <td>遮盖字符为`*`，n=2、m=2</td>
      <td>`**34**`</td>
    </tr>
    <tr>
      <td>遮盖自x至y</td>
      <td>遮盖字符为`*`，x=2、y=5</td>
      <td>`1****6`</td>
    </tr>
    <tr>
      <td>特殊字符（`@`、`&`、`.`）前遮盖（针对首次出现该字符）</td>
      <td>&</td>
      <td rowspan="2">`1@34&6`</td>
      <td>`****&6`</td>
    </tr>
    <tr>
      <td>特殊字符（`@`、`&`、`.`）后遮盖（针对首次出现该字符）</td>
      <td>@</td>
      <td>`1@****`</td>
    </tr>
  </tbody>
</table>

### 替换脱敏

**说明**：待脱敏数据会根据算法描述对应算法配置的随机码表完成数据脱敏，每次脱敏结果都不同。例如，手机号随机替换，脱敏“1390000\*\*\*\*”的结果可能为“1327156\*\*\*\*”、“1835537\*\*\*\*”、“1885654\*\*\*\*”等。

<table>
  <thead>
    <tr>
      <th>适用类型和典型场景</th>
      <th>算法描述</th>
      <th>算法配置</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="11">部分可逆算法。使用替换码表进行映射替换（可逆），或使用随机区间进行随机替换（不可逆），实现字段整体或者部分内容的脱敏。系统预置多套码表可供选择，并支持用户自定义替换算法。<br>适用于证件号等构成规则固定的字段脱敏。<br><ul><li><strong>敏感类型</strong>：<ul><li>个人敏感。</li><li>企业敏感。</li><li>设备敏感。</li></ul></li><li><strong>适用场景</strong>：<ul><li>数据存储。</li><li>数据分享。</li></ul></li></ul></td>
      <td>身份证映射替换</td>
      <td>行政区划随机码表</td>
    </tr>
    <tr>
      <td>身份证随机替换</td>
      <td>行政区划随机码表</td>
    </tr>
    <tr>
      <td>军官证随机替换</td>
      <td>行政区划随机码表</td>
    </tr>
    <tr>
      <td>护照随机替换</td>
      <td>用途字段随机码</td>
    </tr>
    <tr>
      <td>港澳通行证随机替换</td>
      <td>用途字段随机码</td>
    </tr>
    <tr>
      <td>银行卡随机替换</td>
      <td>Bin码随机码表</td>
    </tr>
    <tr>
      <td>座机号码随机替换</td>
      <td>行政区划随机码表</td>
    </tr>
    <tr>
      <td>手机号随机替换</td>
      <td>网号</td>
    </tr>
    <tr>
      <td>统一信用码随机替换</td>
      <td>登记部门随机码表、类别码随机码表、行政区划随机码表</td>
    </tr>
    <tr>
      <td>通用保格映射替换</td>
      <td>大写字母映射码 、小写字母映射码、数字映射码、特殊映射码</td>
    </tr>
    <tr>
      <td>通用保格随机替换</td>
      <td>大写字母随机码 、小写字母随机码、数字随机码 、特殊随机码</td>
    </tr>
  </tbody>
</table>

### 变换脱敏

<table>
  <thead>
    <tr>
      <th>适用类型和典型场景</th>
      <th>算法描述</th>
      <th>算法配置示例</th>
      <th>脱敏前数据示例</th>
      <th>脱敏结果示例</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="3">部分可逆算法。提供对数字或日期等进行取整操作（不可逆）和对文字进行位移操作（可逆）两类变换脱敏算法。<br>适用于对敏感数据集进行分析和统计类场景。<br><ul><li><strong>敏感类型</strong>：通用敏感。</li><li><strong>适用场景</strong>：<ul><li>数据存储。</li><li>数据使用。</li></ul></li></ul></td>
      <td>数字取整：保留小数点前第N位。N的取值范围：1~19。</td>
      <td>N=4</td>
      <td>`12345.6789`</td>
      <td>`12000`</td>
    </tr>
    <tr>
      <td>日期取整：日期取整保留到年、月、日、小时或分钟。</td>
      <td>小时</td>
      <td>`2023-04-15 14:30:45`</td>
      <td>`2023-04-15 14:00:00`</td>
    </tr>
    <tr>
      <td>字符位移：整体循环位移Bit数、向左或向右。</td>
      <td>向左位移3 Bit数</td>
      <td>`test`</td>
      <td>`ttes`</td>
    </tr>
  </tbody>
</table>

### 加密脱敏

<table>
  <thead>
    <tr>
      <th>适用类型和典型场景</th>
      <th>算法描述</th>
      <th>算法配置示例</th>
      <th>脱敏前数据示例</th>
      <th>脱敏结果示例</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="3">可逆算法。支持常见的对称加密算法。<br>适用于对需要回源的字段进行加密的场景。<br><ul><li><strong>敏感类型</strong>：<ul><li>个人敏感。</li><li>企业敏感。</li></ul></li><li><strong>适用场景</strong>：数据存储。</li></ul></td>
      <td>DES算法</td>
      <td>加密密钥：`121212`</td>
      <td rowspan="3">`123456`</td>
      <td>`c2TwheTI+rw=`</td>
    </tr>
    <tr>
      <td>3DES算法</td>
      <td>加密密钥：`123`、`1232131`、`123123`</td>
      <td>`XUwzslGadsk=`</td>
    </tr>
    <tr>
      <td>AES算法</td>
      <td>加密密钥：`123131`</td>
      <td>`YueDcm92UuqvKpVbeS+0Ng==`</td>
    </tr>
  </tbody>
</table>

### 洗牌脱敏

<table>
  <thead>
    <tr>
      <th>适用类型和典型场景</th>
      <th>算法描述</th>
      <th>算法配置</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="1">不可逆算法。在源数据表抽取数据并确认数值范围后，对该字段（在范围内）进行列级别的打散重排和随机选择，实现混淆脱敏。<br>适用于结构化数据列级别的数据脱敏场景。<br><ul><li><strong>敏感类型</strong>：<ul><li>设备敏感。</li><li>位置敏感。</li></ul></li><li><strong>适用场景</strong>：数据存储。</li></ul></td>
      <td>随机洗牌</td>
      <td>
        <ul>
          <li>打散重排</li>
          <li>随机选择</li>
        </ul>
        <br>例如对一组设备所属的城市信息打散重排：<br><br><strong>脱敏前的数据</strong><br><table><thead><tr><th>设备 ID</th><th>城市</th></tr></thead><tbody><tr><td>D001</td><td>上海</td></tr><tr><td>D002</td><td>杭州</td></tr><tr><td>D003</td><td>西安</td></tr><tr><td>D004</td><td>成都</td></tr></tbody></table><br><strong>脱敏后的数据</strong><br><table><thead><tr><th>设备 ID</th><th>城市</th></tr></thead><tbody><tr><td>D001</td><td>西安</td></tr><tr><td>D002</td><td>上海</td></tr><tr><td>D003</td><td>成都</td></tr><tr><td>D004</td><td>杭州</td></tr></tbody></table>
      </td>
    </tr>
  </tbody>
</table>


## 计费说明

目前，仅**企业版** DSC实例支持使用数据脱敏功能。购买企业版实例后，即可使用数据脱敏功能。DSC采用包年包月模式计费。使用静态脱敏时可能会包含额外计费。

| 脱敏方式 | 数据源 | DSC 侧计费 | 额外计费 |
| :--- | :--- | :--- | :--- |
| **静态脱敏** | <ul><li>RDS表、PolarDB-X表、MaxCompute表、PolarDB表、OceanBase表、AnalyticDB-MySQL表、ECS自建数据库表。</li><li>OSS Bucket中结构化TXT、CSV、XLSX和XLS格式文件。</li></ul> | 待脱敏数据资产需要授权接入DSC，会抵扣购买的**数据库防护实例数** 和**存储防护容量** 。 | 如果您需要脱敏的云产品使用的是按量付费的方式，对应云产品会按照访问或写入数据量收取相应的费用。 |
| | 本地计算机保存的结构化TXT、CSV、XLSX和XLS格式文件。 | 目前不抵扣实例的资源。 | 不额外收费。 |
| **动态脱敏** | 自行构造的数据。 | 目前不抵扣实例的资源。 | 不额外收费。 |

## 开通服务

* 如果您当前账号未开通过DSC服务或仅开通免费版服务，您可以先开通7天免费试用的企业版实例或直接购买企业版DSC实例。
* 如果您已开通DSC免费版服务但不是企业版实例，您需要升级版本才能使用数据脱敏功能。

**重要** 如果使用**静态脱敏** ，相关数据资产需要先授权接入DSC，您需要确保已购买足够可用的数据库防护实例数和OSS防护量。

## 静态脱敏

### 功能说明

创建静态脱敏任务时，可以选择**已配置**的**脱敏模板**作为任务的**脱敏规则**，也可以直接设置**目标敏感字段**的**脱敏算法**作为任务的**脱敏规则**。

### 前提条件

如果使用静态脱敏方式脱敏数据库或OSS文件，需要已完成DSC授权和接入待脱敏数据资产。

**重要** 如果需要将脱敏后数据存储到RDS表、PolarDB-X表、MaxCompute表、PolarDB表、OceanBase表、AnalyticDB-MySQL表、自建数据库表或OSS Bucket中，DSC必须授权接入目标数据资产，且使用具有读写权限的账号连接目标数据资产。对于RDS、PolarDB-X、PolarDB、OceanBase或AnalyticDB-MySQL数据库，需要选择账密连接方式接入DSC。

### 新增脱敏任务

**警告** 如果您在生产环境中直接对数据进行脱敏，数据库的性能可能会有所下降。

通过新增脱敏任务，指定数据脱敏的范围和规则。

1.  登录数据安全中心控制台。
2.  在左侧导航栏，选择**风险治理** > **数据脱敏**。
3.  在**静态脱敏** 页签的**任务配置** 页签，单击**新增脱敏任务**。
4.  根据页面导航，完成数据脱敏任务配置。
    1.  填写**任务基本信息**，并单击**下一步**。
        **说明** 任务名称输入不受限制。
    2.  配置脱敏数据的来源文件信息，并单击**下一步**。

        #### **数据库类型**
        (RDS表/PolarDB-X表/MaxCompute表/PolarDB表/OceanBase表/AnalyticDB-MySQL表/自建数据库表)

        | 脱敏源配置项 | 是否必填 | 配置描述 |
        | :--- | :--- | :--- |
        | **数据存储类型** | 是 | 选择脱敏文件的数据存储类型为**RDS 表/PolarDB-X表/MaxCompute表/PolarDB表/OceanBase表/AnalyticDB-MySQL表/自建数据库表**。 |
        | **源产品** | 是 | 选择包含脱敏数据的文件来源的产品名称。支持选择的产品包括：**RDS** 、**PolarDB-X** 、**OceanBase** 、**MaxCompute** 、**AnalyticDB-MySQL**、**PolarDB** 或**自建数据库** 。 |
        | **源数据库/项目名** | 是 | 选择包含脱敏数据的表所在的项目名称。 |
        | **源表名** | 是 | 选择脱敏数据所在的数据表名称。 |
        | **源分区** | 否 | 仅**源产品** 选择**MaxCompute** 时，可配置**源分区** 。输入需要脱敏的数据在数据表中的分区名称。不填写则代表会对整个表中的敏感数据进行脱敏。分区是在创建MaxCompute数据表时指定的分区空间，用于限定不同区域数据，方便快速和高效地对指定内容进行查询。 |
        | **抽样 SQL** | 否 | **源产品** 选择**RDS** 、**PolarDB-X** 、**OceanBase** 或**自建数据库** 时，可配置**抽样 SQL**。输入SQL语句配置脱敏数据的范围。不填写则进行全表脱敏。 |
        
        #### **OSS文件类型**

        **重要** 仅支持脱敏结构化TXT、CSV、XLSX和XLS格式的文件。

        | 脱敏源配置项 | 是否必填 | 配置描述 |
        | :--- | :--- | :--- |
        | **数据存储类型** | 是 | 选择脱敏文件的数据存储类型为**OSS 文件**。 |
        | **文件源** | 是 | 选择OSS文件的来源，支持**本地上传** 和**OSS Bucket** 。 |
        | **上传文件** | 是 | **文件源** 为**本地上传** 时，单击**选择本地文件** ，上传需要脱敏的文件。 |
        | **源文件所在 OSS Bucket** | 是 | **文件源** 为**OSS Bucket** 时，在下拉列表中选择源文件所在的OSS Bucket。您也可以输入关键字进行搜索并选择源文件所在的OSS Bucket。 |
        | **源文件名称** | 是 | **文件源** 为**OSS Bucket** 时，输入源文件的名称。源文件名称必须包含格式后缀。 <ul><li>**单个文件脱敏**：输入指定源文件名称。例如，`test.csv`。</li><li>**批量文件脱敏**：开启通配功能（单击右侧的**开启通配**开关）。系统采用同一规则脱敏目标文件，多个文件的格式必须相同，且具有相同的列结构。您可以使用星号（\*）的方式指定一批源文件进行批量脱敏。目前仅支持对文件名前缀进行匹配，例如，`test*.xls`，匹配以`test`开头的XLS格式文件。</li></ul> |
        | **源文件描述** | 否 | **文件源** 为**本地上传** 时，可输入对OSS源文件的描述。 |
        | **分隔符选择** | 否 | 对于CSV和TXT类型的文件，必须指定列分隔符，请根据源文件的分隔符类型进行选择。支持选择以下类型的分隔符： <ul><li>**分号“;”（macOS、Linux 默认）**。</li><li>**逗号“,”（Windows 默认）**。</li><li>**运算符“\|”** 。</li></ul> |
        | **表格包含标题行** | 否 | 根据源文件是否包含标题行进行选择。 |
    
    3.  选择以下方式配置脱敏算法，然后单击**下一步**。
        * 在数据列表上方选择已配置的脱敏模板，源字段列表会按照脱敏模板配置，自动开启对应字段的**脱敏开关** 并设置**算法选择**。
            > 脱敏模板中规则列表内容必须与脱敏源数据的源字段匹配，否则脱敏模板不生效。
        * 直接在源字段列表中，定位到需要脱敏的源字段，开启**脱敏开关** 并设置**算法选择**。
            > 单击脱敏算法后的**参数查看修改**，可查看和编辑已选择算法的规则。算法规则中分区写法，可参考**分区写法参考表**。
        
        **说明** 如果开启**强制启用模板**，不支持在当前页面修改算法参数。您需要修改对应模板规则。

#### 分区写法参考表

| 分区类型 | 分区写法 | 分区示例 |
| :--- | :--- | :--- |
| 后N周 | 自定义分区字段名称=`$[yyyymmdd+7*N]` | `time=$[20190710+7*1]`，表示对2019年7月10日后一周的数据进行脱敏。 |
| 前N周 | 自定义分区字段名称=`$[yyyymmdd-7*N]` | `time=$[20190710-7*3]`，表示对2019年7月10日前的3周时间内的数据进行脱敏。 |